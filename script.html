<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Lấy Transcript YouTube</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    textarea { width: 100%; height: 200px; }
    button { padding: 10px 20px; margin: 10px 0; }
    pre { background: #f7f7f7; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Lấy Transcript YouTube</h2>
  <p>Nhập danh sách URL YouTube (mỗi dòng một URL):</p>
  <textarea id="urlInput"></textarea>
  <br>
  <button onclick="getTranscripts()">Lấy transcript</button>
  <h3>Kết quả:</h3>
  <pre id="output"></pre>
  <button id="downloadBtn" style="display:none;" onclick="downloadFile()">Tải về dulieu.txt</button>

  <script>
    const API_URL = "https://www.youtube-transcript.io/api/transcripts";
    const API_TOKEN = "68a227676f9cf35849bd72b5"; // gắn cứng token

    // Tách video ID từ URL
    function extractVideoId(url) {
      const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return match ? match[1] : null;
    }

    // Delay
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function formatTime(secondsStr) {
      try {
        const seconds = parseFloat(secondsStr);
        const minutes = Math.floor(seconds / 60);
        const remain = Math.floor(seconds % 60);
        return `${minutes.toString().padStart(2, "0")}:${remain
          .toString()
          .padStart(2, "0")}`;
      } catch {
        return "00:00";
      }
    }

    async function fetchBatch(ids) {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Authorization": "Basic " + API_TOKEN,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ ids }),
      });

      if (resp.status === 429) {
        const retryAfter = parseInt(resp.headers.get("Retry-After") || "3");
        await delay(retryAfter * 1000);
        return fetchBatch(ids); // thử lại
      }
      if (!resp.ok) {
        console.error("HTTP error", resp.status);
        return [];
      }
      return await resp.json();
    }

    async function getTranscripts() {
      const urls = document.getElementById("urlInput").value.split("\n").map(x => x.trim()).filter(Boolean);
      const ids = urls.map(extractVideoId).filter(Boolean);

      if (!ids.length) {
        alert("Không tìm thấy ID video hợp lệ.");
        return;
      }

      let results = [];
      for (let i = 0; i < ids.length; i += 50) {
        const batch = ids.slice(i, i + 50);
        const data = await fetchBatch(batch);
        results = results.concat(data);
        if (i + 50 < ids.length) {
          await delay(3000); // nghỉ 3 giây giữa các batch
        }
      }

      // Format ra text
      let textOutput = "";
      results.forEach((video, idx) => {
        const title = video.title || "Không có tiêu đề";
        let transcriptText = "Không có nội dung.";

        if (video.tracks && video.tracks[0]?.transcript) {
          const lines = video.tracks[0].transcript.map(line => {
            const ts = formatTime(line.start);
            const t = (line.text || "").replace(/\n/g, " ");
            return `${ts} ${t}`;
          });
          transcriptText = lines.join("\n");
        }

        textOutput += `Kịch bản ${idx + 1}\n`;
        textOutput += `Tiêu đề: ${title}\n`;
        textOutput += "Nội dung:\n";
        textOutput += transcriptText + "\n\n";
        textOutput += "---\n\n";
      });

      document.getElementById("output").textContent = textOutput;
      document.getElementById("downloadBtn").style.display = "inline-block";
      window.transcriptText = textOutput; // lưu để tải
    }

    function downloadFile() {
      const blob = new Blob([window.transcriptText], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dulieu.txt";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
